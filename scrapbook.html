<!DOCTYPE html>
<html>
    <head>
        <title>{{ .Title }}</title>
    </head>
    <style>
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
        }
    </style>
    <script>
        var Sitemap
        var editTargetDiv

        async function init(){
            var res = await fetch(`/sitemap.json`)
            if (res.status === 200) {
                Sitemap = await res.json()
                console.log(Sitemap)
                renderPage()
                createPageButtons()
            } else {
                alert("Error fetching site data.")
            }

        }

        function renderPage(){
            document.getElementById("page-frame").innerHTML = ""
            for (let i = 0; i < Sitemap.Pages.length; i++){
                if (Sitemap.Pages[i].Header.URI == window.location.pathname) {
                    for (let j = 0; j < Sitemap.Pages[i].Elements.length; j++){
                        document.getElementById("page-frame").appendChild(renderElement(Sitemap.Pages[i].Elements[j]))
                    }
                    createPageEditors(Sitemap.Pages[i])
                    return
                }
            }
        }

        function renderElement(element){
            let newDOMElement 
            if (element.IsLink) {
                newDOMElement = document.createElement("a")
                newDOMElement.href = element.LinkURL
            }
            else {
                newDOMElement = document.createElement("div")
            }
            
            newDOMElement.innerHTML = element.Content
            newDOMElement.style.height = `${element.Height}rem`
            newDOMElement.style.width = `${element.Width}rem`
            newDOMElement.id = element.ID

            for (var i = 0; i < Sitemap.Styles.length; i++){
                if (Sitemap.Styles[i].ID == element.StyleID) {
                    let s = Sitemap.Styles[i]
                    if (s.BackgroundType == "color"){
                        newDOMElement.style.backgroundColor = s.BackgroundData
                    }
                    newDOMElement.style.backgroundPosition = s.BackgroundPosition
                    newDOMElement.style.backgroundSize = s.BackgroundSite
                    newDOMElement.style.border = `${s.BorderWidth}px ${s.BorderStyle} ${s.BorderColor}`
                    newDOMElement.style.color = s.FontColor
                    newDOMElement.style.fontFamily = s.FontFamily
                    newDOMElement.style.fontSize = `${s.FontSize}rem`
                    newDOMElement.style.fontWeight = s.FontWeight
                    newDOMElement.style.margin = s.Margin
                    newDOMElement.style.padding = s.Padding
                    newDOMElement.style.textAlign = s.TextAlign
                    break
                }
            }

            
            if (element.Children.length == 0){
                newDOMElement.contentEditable = true
            }
            newDOMElement.addEventListener('keypress', function(event) {
                if (event.keyCode == 13 && event.shiftKey == false) { // enter keycode is 13
                event.preventDefault(); 
                document.execCommand("insertLineBreak");    
                } 
            });
            newDOMElement.addEventListener("click", function(e){
                editTargetDiv = element
                e.stopPropagation()
            })
            newDOMElement.addEventListener("input", function(e){
                editTargetDiv.Content = document.getElementById(editTargetDiv.ID).innerText
                e.stopPropagation()
            })                
            
            
            for (var i = 0; i < element.Children.length; i++){
                newDOMElement.appendChild(renderElement(element.Children[i]))
            }
            return newDOMElement
        }

        async function enableEdit(password){
            var res = await fetch(`/editapi/requestedit?p=${password}`)
            if (res.ok) {
                console.log("Edit mode active.")
                renderPage()
            }
            else {
                console.log("Invalid password.")
            }
        }

        async function saveEdit() {
            const options = {
                method: 'POST', // HTTP method
                headers: {
                'Content-Type': 'application/json', // Set the request header to JSON
                },
                body: JSON.stringify(Sitemap), // Convert the data object to a JSON string
            };
            var res = await fetch("/editapi/save", options)
            if (res.ok) {
                console.log("Changes saved.")
            }
            else {
                console.log("Error.")
            }
        }

        function createPageButtons(){
            var frame = document.getElementById("edit-pages")
            frame.innerHTML = ""
            let n = document.createElement("button")
            n.innerHTML = "+ New Page"
            n.onclick = createNewPage
            frame.appendChild(n)
            for (var i = 0; i < Sitemap.Pages.length; i++){
                let b = document.createElement("button")
                b.innerHTML = Sitemap.Pages[i].Header.URI
                let title = Sitemap.Pages[i].Header.Title
                let uri = Sitemap.Pages[i].Header.URI
                b.addEventListener("click", (e)=>{
                    window.history.pushState("Test", title, uri);
                    renderPage()
                })
                frame.appendChild(b)
            }
        }

        function createPageEditors(page){
            let frame = document.getElementById("edit-page")
            frame.innerHTML = ""

            // Title edit
            let f = document.createElement("div")
            let t = document.createElement("div")
            t.innerHTML = "Page Title"
            let p = document.createElement("input")
            p.type = "text"
            p.value = page.Header.Title
            p.addEventListener("change", (e)=>{
                setPageHeaderValue("Title", p.value)
            })
            f.appendChild(t)
            f.appendChild(p)
            frame.appendChild(f)

            // URI edit
            f = document.createElement("div")
            t = document.createElement("div")
            t.innerHTML = "Page URI"
            u = document.createElement("input")
            u.type = "text"
            u.value = page.Header.URI
            u.addEventListener("change", (e)=>{
                setPageHeaderValue("URI", u.value)
                window.history.pushState("Test", "processing", u.value);
                renderPage()
                createPageButtons()
            })
            f.appendChild(t)
            f.appendChild(u)
            frame.appendChild(f)

            // Description edit
            f = document.createElement("div")
            t = document.createElement("div")
            t.innerHTML = "Page Description"
            d = document.createElement("input")
            d.type = "text"
            d.value = page.Header.Description
            d.addEventListener("change", (e)=>{
                setPageHeaderValue("Description", d.value)
            })
            f.appendChild(t)
            f.appendChild(d)
            frame.appendChild(f)

            // PreviewImage edit
            f = document.createElement("div")
            t = document.createElement("div")
            t.innerHTML = "Preview Image"
            s = document.createElement("select")
            n = document.createElement("option")
            n.value = ""
            n.innerHTML = "None"
            s.appendChild(n)
            for (var j = 0; j < Sitemap.Media.length; j++){
                o = document.createElement("option")
                o.value = Sitemap.Media[j].MediaID
                o.innerHTML = Sitemap.Media[j].MediaName
                s.appendChild(o)
            }
            s.value = page.Header.PreviewImage
            s.addEventListener("change", (e)=>{
                setPageHeaderValue("PreviewImage", s.value)
                if (s.value != "") {
                    setPageHeaderValue("HasPreviewImage", true)
                } else {
                    setPageHeaderValue("HasPreviewImage", false)
                }
            })

            f.appendChild(t)
            f.appendChild(s)
            frame.appendChild(f)
        }

        function createNewPage(){
            let i = 0;
            while (i < 100) {
                valid = true
                for (var j = 0; j < Sitemap.Pages.length; j++){
                    if (Sitemap.Pages[j].Header.URI == `/newpage${i}`) {
                        valid = false
                    }
                }
                if (valid) {
                    break
                }
                i++
            }
            Sitemap.Pages.push({
                Header: {
                    Description: "Default Description",
                    HasPreviewImage: false,
                    PreviewImage: "",
                    Title: "New Page",
                    URI: `/newpage${i}`,
                },
                Elements: []
            })
            createPageButtons()
        }

        function setPageHeaderValue(key, value){
            for (var i = 0; i < Sitemap.Pages.length; i++){
                if (Sitemap.Pages[i].Header.URI == window.location.pathname){
                    Sitemap.Pages[i].Header[key] = value
                }
            }
        }

        function setElementValue(elementID, key, value){
            let target = getElementById(elementID)
            target[key] = value
        }

        function getElementByID(elementID){
            for (var i = 0; i < Sitemap.Pages.length; i++){
                for (var j = 0; j < Sitemap.Pages[i].Elements.length; j++){
                    let foundElement = nestedElementSearch(elementID, Sitemap.Pages[i].Elements[j])
                    if (foundElement) {
                        return foundElement
                    }
                }
            }
            return false
        }

        function nestedElementSearch(elementID, searchElement){
            if (searchElement.ID == elementID){
                return searchElement
            }
            else {
                for (var i = 0; i < searchElement.Children.length; i++){
                    let foundElement = nestedElementSearch(elementID, searchElement.Children[i])
                    if (foundElement) {
                        return foundElement
                    }
                }
                return false
            }
        }

        function uploadFile() {
            var file = document.getElementById("file-upload").files[0]
            document.getElementById("file-upload-label").style.display = "none"
            var formdata = new FormData();
            formdata.append("upload", file);
            var uploadReq = new XMLHttpRequest();
            uploadReq.upload.addEventListener("progress", progressHandler, false);
            uploadReq.addEventListener("load", completeHandler, false);
            uploadReq.addEventListener("error", errorHandler, false);
            uploadReq.addEventListener("abort", abortHandler, false);
            uploadReq.open("POST", "/editapi/upload");
            uploadReq.send(formdata);
        }

        function progressHandler(event) {
            var bar = document.getElementById("upbar-inner");
            var uploadStatus = document.getElementById("upbar-text");
            var percent = (event.loaded / event.total) * 100;
            if (percent == 100) {
                uploadStatus.innerHTML = `Processing`;
                bar.style.width = `${percent}%`;
                bar.style.backgroundColor = "DodgerBlue";
            }
            else {
                uploadStatus.innerHTML = `Uploaded ${Math.round(percent)}%`;
                bar.style.width = `${percent}%`;
            }
        }

        function errorHandler(event){
            document.getElementById("upbar-inner").style.backgroundColor = "red";
            document.getElementById("upbar-text").innerHTML = "Error"
            document.getElementById("file-upload-label").style.display = "inline-block"
        }

        function abortHandler(event){
            document.getElementById("upbar-inner").style.backgroundColor = "red";
            document.getElementById("upbar-text").innerHTML = "Aborted"
            document.getElementById("file-upload-label").style.display = "inline-block"
        }

        function completeHandler(event){
            document.getElementById("upbar-inner").style.backgroundColor = "green";
            document.getElementById("upbar-text").innerHTML = "Done"
            document.getElementById("file-upload-label").style.display = "inline-block"
        }

        window.onload = init
    </script>
    <body>
        <div id="page-frame">

        </div>
        <div id="edit-frame" style="position: fixed; top: calc(100vh - 100px); left: 0px; height: 100px; width: 100rem; background-color: brown;">

            <div id="edit-pages" style="position: relative; top: 0px; left: 0px; width: 100rem; height: 30px; background-color: blue;">

            </div>
            <div id="edit-page" style="position: relative; top: 0px; left: 0px; width: 100rem; height: 40px; background-color: green; display: flex;">

            </div>
            <div id="edit-functions" style="position: relative; top: 0px; left: 0px; width: 100rem; height: 40px; background-color: orange; display: flex;">
                <label id="file-upload-label" for="file-upload" class="custom-file-upload">
                    Upload Media/Font
                </label>
                <input id="file-upload" type="file" name="upload" onchange="uploadFile();"/>
                <div id="upbar-outer" style="height: 30px; width: 100px; background-color: white; position: relative;">
                    <div id="upbar-inner" style="height: 30px; width: 0%; background-color: green;"></div>
                    <div id="upbar-text" style="position: absolute; top: 0px; left: 0px; z-index: 1;"></div>
                </div>
                <button onclick="saveEdit()">
                    Save Changes
                </button>
                <button>
                    Exit Edit Mode
                </button>
            </div>
            
            <!-- <button onclick="saveEdit()">Save</button>
            <form action="/editapi/upload" method="POST" enctype="multipart/form-data">
                <input type="file" name="upload">
                <input type="submit">
            </form> -->
        </div>
    </body>
    </html>